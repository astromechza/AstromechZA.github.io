<!doctype html><html lang=en-us><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-49279373-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-49279373-1")</script><title>AstromechZA - Ben Meier</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="The HTML5 Herald"><meta name=author content="Ben Meier"><link href=https://github.com/astromechza rel=me><link href=https://hachyderm.io/@benmeier_ rel=me><meta name=generator content="Hugo 0.110.0"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda"><link rel=stylesheet type=text/css href=https://astromechza.github.io/css/styles.css></head><body><div id=container><header><h1><a href=https://astromechza.github.io/>AstromechZA - Ben Meier</a></h1><ul id=social-media class=fa-ul><li><a href=https://hachyderm.io/@benmeier_><i class="fab fa-mastodon fa-fw"></i></a></li><li><a href=https://twitter.com/@benmeier_><i class="fab fa-twitter fa-fw"></i></a></li><li><a href=https://github.com/AstromechZA><i class="fab fa-github fa-fw"></i></a></li></ul><p><em>My Mind on Code</em></p></header><nav><ul><li><a class=active href=https://astromechza.github.io/posts/><i class="fa-li fa fa-lg"></i><span>All Posts</span></a></li></ul></nav><main><article><h1>Building an NTP agent</h1><aside><ul><li><time class=post-date datetime=2016-09-10T21:23:26+01:00>Sep 10, 2016</time></li><li>9 min read</li></ul></aside><p>My home/media server has a small Grafana instance with a <a href=http://github.com/AstromechZA/spoon>Spoon</a>
instance collecting and reporting metrics to it (network stats, disk usage, etc..). It&rsquo;s been
running for quite a while now and I&rsquo;ve used the stats for a bunch of things so
far. Recently I was adding an additional ping test metric and noticed something
interesting while I was on the server:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>macbook$ date <span style=color:#f92672>&amp;&amp;</span> ssh ben@192.168.1.2 date
</span></span><span style=display:flex><span>Sat Sep <span style=color:#ae81ff>10</span> 10:09:40 SAST <span style=color:#ae81ff>2016</span>       &lt;-- time from macbook
</span></span><span style=display:flex><span>Sat Sep <span style=color:#ae81ff>10</span> 10:17:07 SAST <span style=color:#ae81ff>2016</span>       &lt;-- time from microserver
</span></span></code></pre></div><blockquote><p>Oops</p></blockquote><p>The time was REALLY out of sync. I&rsquo;m not too suprised though. The server isn&rsquo;t
running an NTP update daemon and it&rsquo;s a shitty little microserver which has had
time issues in the past. In the age of NTP, hardware clocks don&rsquo;t <em>have</em> to be
as reliable as they could be.</p><p>For those that don&rsquo;t know. NTP (Network Time Protocol) is an age old and
time-proven protocol for synchronising a large number of servers clocks. It is
basically structured like a hierarchy of &ldquo;strata&rdquo; with a few super-reliable,
super-accurate time sources in &ldquo;Stratum 0&rdquo; connected to time servers in
&ldquo;Stratum 1&rdquo; with layers of descendent servers in peer-to-peer networks below them.</p><p><img src=https://astromechza.github.io/images/2016-09-10/stratum.png alt="NTP strata"></p><p>I started going through the process of looking at how to setup NTP update on
an Ubuntu server, but halfway through that I thought:</p><blockquote><p>How hard can building an NTP update client be?? It&rsquo;s just getting an accurate
time and pushing your local clock towards that&mldr; right?</p></blockquote><p>My knowledge of NTP before this was redimentary: I knew there were hierachies of
time servers but had no idea of the complexity of the communication protocol.
This series of blog posts will hopefully shed some light on that as I work
through building my own NTP client.</p><hr><h3 id=1-who-are-my-upstream-servers-and-how-do-i-communicate-with-them>1. Who are my upstream servers and how do I communicate with them?</h3><p>Looking at the stratum diagram, my server is in stratum &ldquo;N&rdquo;. I need to pull time
information from stratum &ldquo;N-1&rdquo; or from other peers on the network. Since I don&rsquo;t
have any peers, I&rsquo;ll need to rely on some NTP pool servers. The organisation at
<a href=http://www.pool.ntp.org/en/use.html>www.pool.ntp.org</a> has a great explanation
of how their pools work and various other considerations and also allows you to
drill down and target specific continent or country local servers.</p><p>At the time of writing:</p><ul><li>pool.ntp.org had 2635 servers</li><li>africa.pool.ntp.org had 33</li><li>za.pool.ntp.org had 21</li></ul><p>I&rsquo;m going to be using the <code>za</code> pool for my experiments, just to keep latency
down, but it should be completely configurable.</p><p>ntp.org allows you to address the pool using the four domains <code>{0,1,2,3}.za.pool.ntp.org</code>.
The DNS lease changes quite frequently as the available servers in the pool are chosen for duty.
Each of the servers that those domains resolve to is listening on the NTP port
<code>123</code> for NTP packets.</p><p>The best description of the NTP protocol I could find was this
<a href=https://www.eecis.udel.edu/~mills/database/reports/ntp4/ntp4.pdf>90 page PDF</a>.
Pretty heavy reading, but the most reliable source I could find that had
text, diagrams, and sample source code for the algorithms.</p><p>It&rsquo;s great that NTP uses UDP since this makes writing a client <em>much</em> easier than a TCP protocol.
The simplest UDP client packet that can be sent is almost completely zeroes. The
only filled in fields of the 48 byte packet are the 3-bit version and 3-bit mode
at the start. This outgoing packet will get a little more filled in later. But
this is the minimum required to get a response from an NTP server.</p><pre tabindex=0><code>00 100 011 0000000000....000
   --- ---
</code></pre><p>For more details of what all the fields mean look at page 11 and 43 of the
pdf.</p><p>A quick client in Golang to send an NTP request to multiple upstream servers:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getNTP</span>(<span style=color:#a6e22e>server</span> <span style=color:#66d9ef>string</span>) (<span style=color:#f92672>*</span>[]<span style=color:#66d9ef>byte</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>svrAddr</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>ResolveUDPAddr</span>(<span style=color:#e6db74>&#34;udp&#34;</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%s:%d&#34;</span>, <span style=color:#a6e22e>server</span>, <span style=color:#ae81ff>123</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> { <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>DialUDP</span>(<span style=color:#e6db74>&#34;udp&#34;</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>svrAddr</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> { <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>buf</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>byte</span>, <span style=color:#ae81ff>48</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>buf</span>[<span style=color:#ae81ff>0</span>] = <span style=color:#ae81ff>0x23</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>buf</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> { <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>inbuf</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>byte</span>, <span style=color:#ae81ff>1024</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>n</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>ReadFromUDP</span>(<span style=color:#a6e22e>inbuf</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> { <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span> }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>response</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>inbuf</span>[:<span style=color:#a6e22e>n</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>response</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>server</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Args</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getNTP</span>(<span style=color:#a6e22e>server</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;%x\n&#34;</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>Nets us:</p><pre tabindex=0><code>$ ./ntp-blog 0.pool.ntp.org 1.pool.ntp.org 2.pool.ntp.org 3.pool.ntp.org
240203ed00000000000002d67f7f0100db7e4f188fc8c3d00000000000000000db7e4f229dafd5d5db7e4f229dbda7f0
240203e90000066b000004b0c415bb02db7e4eda5d8d01850000000000000000db7e4f23cf980d0edb7e4f23cfa11750
240203e9000003a500000fabc415bb02db7e47a34ad22a210000000000000000db7e4f2410516b24db7e4f241062d562
240303e80000361700000a93c550447bdb7e4e9c7d8d8d450000000000000000db7e4f24f2920ab3db7e4f24f2955cfa
</code></pre><p>Seems legit. Next is parsing those responses.</p><h3 id=2-parsing-an-ntp-packet>2. Parsing an NTP packet</h3><p>UDP packets are meant to be as small and reliable as possible and so are
usually packed very densely with information. NTP packets are no different.</p><p>The basic 48 byte packet for both the client and the server looks like the
following:</p><p><img src=https://astromechza.github.io/images/2016-09-10/packetfmt.png alt="NTP strata"></p><p>So we just have to setup a data structure (<code>RawPacket</code>) and some methods to
encode and decode it to the same 48 byte format.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>RawPacket</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LeapIndicator</span> <span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Version</span> <span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Mode</span> <span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Stratum</span> <span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Poll</span> <span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Precision</span> <span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>RootDelay</span> <span style=color:#66d9ef>int32</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>RootDispersion</span> <span style=color:#66d9ef>int32</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ReferenceID</span> <span style=color:#66d9ef>int32</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ReferenceTimestamp</span> <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>OriginateTimestamp</span> <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ReceiveTimestamp</span> <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>TransmitTimestamp</span> <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I&rsquo;m not going to write all the code inline here. Just capture some of the
important bits. Anything else I&rsquo;ll link to afterwards in the repo for the
project.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ParseRawPacket</span>(<span style=color:#a6e22e>input</span> <span style=color:#f92672>*</span>[]<span style=color:#66d9ef>byte</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>RawPacket</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>inputData</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>input</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// check incoming data length
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>inputData</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>48</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;Incoming packet must be 48 bytes&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// build output structure
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>output</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>RawPacket</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// first byte
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>b1</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>inputData</span>[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>output</span>.<span style=color:#a6e22e>LeapIndicator</span> = (<span style=color:#a6e22e>b1</span> <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>6</span>) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0x2</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>output</span>.<span style=color:#a6e22e>Version</span> = (<span style=color:#a6e22e>b1</span> <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>3</span>) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0x7</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>output</span>.<span style=color:#a6e22e>Mode</span> = <span style=color:#a6e22e>b1</span> <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0x7</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// next 3 bytes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>output</span>.<span style=color:#a6e22e>Stratum</span> = <span style=color:#a6e22e>inputData</span>[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>output</span>.<span style=color:#a6e22e>Poll</span> = <span style=color:#a6e22e>inputData</span>[<span style=color:#ae81ff>2</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>output</span>.<span style=color:#a6e22e>Precision</span> = <span style=color:#a6e22e>inputData</span>[<span style=color:#ae81ff>3</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// remaining components
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>output</span>.<span style=color:#a6e22e>RootDelay</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>getInt32</span>(<span style=color:#a6e22e>input</span>, <span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> { <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span> }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>output</span>.<span style=color:#a6e22e>RootDispersion</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>getInt32</span>(<span style=color:#a6e22e>input</span>, <span style=color:#ae81ff>8</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> { <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span> }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>output</span>.<span style=color:#a6e22e>ReferenceID</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>getInt32</span>(<span style=color:#a6e22e>input</span>, <span style=color:#ae81ff>12</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> { <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span> }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>output</span>.<span style=color:#a6e22e>ReferenceTimestamp</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>getInt64</span>(<span style=color:#a6e22e>input</span>, <span style=color:#ae81ff>16</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> { <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span> }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>output</span>.<span style=color:#a6e22e>OriginateTimestamp</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>getInt64</span>(<span style=color:#a6e22e>input</span>, <span style=color:#ae81ff>24</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> { <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span> }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>output</span>.<span style=color:#a6e22e>ReceiveTimestamp</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>getInt64</span>(<span style=color:#a6e22e>input</span>, <span style=color:#ae81ff>32</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> { <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span> }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>output</span>.<span style=color:#a6e22e>TransmitTimestamp</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>getInt64</span>(<span style=color:#a6e22e>input</span>, <span style=color:#ae81ff>40</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> { <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>output</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getInt32</span>(<span style=color:#a6e22e>input</span> <span style=color:#f92672>*</span>[]<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>position</span> <span style=color:#66d9ef>int</span>) (<span style=color:#66d9ef>int32</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getInt64</span>(<span style=color:#a6e22e>input</span> <span style=color:#f92672>*</span>[]<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>position</span> <span style=color:#66d9ef>int</span>) (<span style=color:#66d9ef>int64</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Our struct prints quite reliably now:</p><pre tabindex=0><code>$ ./ntp-blog 0.pool.ntp.org 1.pool.ntp.org 2.pool.ntp.org 3.pool.ntp.org
{0 4 4 3 3 232 13866 5338 -984595333 -2630542190490089860 0 -2630535662870812375 -2630535662870604122}
{0 4 4 2 3 234 2102 3176 -1005208830 -2630538858014520027 0 -2630535662636034478 -2630535662635204098}
{0 4 4 3 0 236 320 1342 693010449 -2630535707210498351 0 -2630535662448759907 -2630535662448722089}
{0 4 4 2 3 233 3013 1404 3967938 -2630536493219449208 0 -2630535662258047584 -2630535662257932277}
</code></pre><h3 id=3-building-a-time-object-from-the-64bit-ntp-timestamp>3. Building a Time object from the 64bit NTP timestamp</h3><p>The final part of this post is extracting the actual Time value that the NTP
server is transmitting. The format it uses is fairly interesting:</p><blockquote><p>The 64-bit timestamp format is used in packet headers and other places with limited word size. It
includes a 32-bit unsigned seconds field spanning 136 years and a 32 bit fraction field resolving
232 picoseconds.</p></blockquote><p>I borrowed this technique of doing it from Apache commans library:
<a href="http://svn.apache.org/viewvc/commons/proper/net/trunk/src/main/java/org/apache/commons/net/ntp/TimeStamp.java?view=markup">net/ntp/TimeStamp.java</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>intMask</span> = <span style=color:#ae81ff>0xFFFFFFFF</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>era1900</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>2208988800</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>era2036</span> = <span style=color:#ae81ff>2085978496</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>nanosecondsPerSecond</span> = <span style=color:#ae81ff>1e9</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ConvertNTPToSeconds</span>(<span style=color:#a6e22e>input</span> <span style=color:#66d9ef>int64</span>) <span style=color:#66d9ef>float64</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// first convert to unsigned
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>uinput</span> <span style=color:#f92672>:=</span> uint64(<span style=color:#a6e22e>input</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// get integral seconds
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>seconds</span> <span style=color:#f92672>:=</span> (<span style=color:#a6e22e>uinput</span> <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>32</span>) <span style=color:#f92672>&amp;</span> <span style=color:#a6e22e>intMask</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// isolate fractions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>fraction</span> <span style=color:#f92672>:=</span> (<span style=color:#a6e22e>uinput</span> <span style=color:#f92672>&amp;</span> <span style=color:#a6e22e>intMask</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// convert into seconds
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>extra</span> <span style=color:#f92672>:=</span> float64(<span style=color:#a6e22e>fraction</span>) <span style=color:#f92672>/</span> float64(<span style=color:#ae81ff>0x100000000</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>accumulated</span> <span style=color:#f92672>:=</span> float64(<span style=color:#a6e22e>seconds</span>) <span style=color:#f92672>+</span> <span style=color:#a6e22e>extra</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// pull the MSB of the seconds
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// if this is set then we are in the next &#34;era&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>msb</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>seconds</span> <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0x80000000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// combine with magic offset time depending on the era
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>msb</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// after year 2036
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>accumulated</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>era2036</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// after year 1900
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>accumulated</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>era1900</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ConvertSecondsToTime</span>(<span style=color:#a6e22e>input</span> <span style=color:#66d9ef>float64</span>) <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// pull out the seconds and fractional seconds
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>seconds</span>, <span style=color:#a6e22e>frac</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>Modf</span>(<span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>Abs</span>(<span style=color:#a6e22e>input</span>))
</span></span><span style=display:flex><span>    <span style=color:#75715e>// convert to nanoseconds and build
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Unix</span>(int64(<span style=color:#a6e22e>seconds</span>), int64(<span style=color:#a6e22e>frac</span> <span style=color:#f92672>*</span> float64(<span style=color:#a6e22e>nanosecondsPerSecond</span>)))
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ConvertNTPToTime</span>(<span style=color:#a6e22e>input</span> <span style=color:#66d9ef>int64</span>) <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// all together now
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ConvertSecondsToTime</span>(<span style=color:#a6e22e>ConvertNTPToSeconds</span>(<span style=color:#a6e22e>input</span>))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>So now we can print out the transmit time stamps of the incoming packets!</p><pre tabindex=0><code>$ ./ntp-blog 0.za.pool.ntp.org 1.za.pool.ntp.org 2.za.pool.ntp.org 3.za.pool.ntp.org
{0 4 4 2 3 233 1637 1612 -1005208830 -2630533090589107248 0 -2630530882002116997 -2630530882001927291}
2016-09-10 14:24:57.592065811 +0200 SAST
{0 4 4 2 3 234 205 135 692805679 -2630530984411593606 0 -2630530878018216308 -2630530878018054843}
2016-09-10 14:24:58.519639968 +0200 SAST
{0 4 4 2 3 232 14465 2045 -1071249424 -2630534685670322021 0 -2630530876233854186 -2630530876233641078}
2016-09-10 14:24:58.935093879 +0200 SAST
{0 4 4 2 3 237 0 718 2139029760 -2630530886426329555 0 -2630530875228689786 -2630530875227833139}
2016-09-10 14:24:59.169126987 +0200 SAST
</code></pre><p>If you wanted to, you could stop here. Just pick one or average them out, and
set your system clock. If your server is out by multiple minutes and you just
want to get things close enough, this would be perfectly fine for you. The
<code>ntp4.pdf</code> document linked earlier suggests this as a minimum implementation
of an SNTPv4 Client:</p><blockquote><p>11.2 SNTPv4 Client Configuration:
There is a wide spectrum of SNTPv4 client configurations, with each providing
different levels of accuracy and reliability. Since only local client
applications are supported, to use or not use one or more of the NTPv4
algorithms is a matter of local choice. As a bare minimum, a SNTPv4 client
application constructs a packet with only the version number filled in and sends
it to the NTPv4 or SNTPv4 server. The server operates as in the previous section
to return the packet, but only the transmit timestamp (T3) is useful. The SNTPv4
client application converts from NTP timestamp format to system time format,
sets the system clock to this value and exits. The application can be called at
defined intervals or manually.</p></blockquote><p>The problem is that in complex network environments like the internet, packets
take time, might never arrive, could be arbitrarily delayed, could be maliciously
constructed or highjacked; the remote NTP server might even be completely wrong
or send pure garbage back to you. How you do handle all of these conditions
intelligently? Sure, some basic heuristics about how far you&rsquo;re allowed to change
the clock and by how much could help, but when you want to synchronise clocks
down to the microsecond level or lower you probably need something a bit more
complex.</p><p><a href=http://astromechza.github.io/2016/09/11/ntp-agent-part-2.html>Part 2</a> of this
post will take up the challenge of looking at building a more accurate SNTPv4 Client.</p></article><section class=post-nav><ul><li><a href=https://astromechza.github.io/posts/2015-03-09-building-whereismypower/><i class="fa fa-chevron-circle-left"></i> Building whereismypower.co.za</a></li><li><a href=https://astromechza.github.io/posts/2016-09-14-the-road-to-hyperthreading/>The road to hyperthreading <i class="fa fa-chevron-circle-right"></i></a></li></ul></section></main><footer><h6>Copyright © 2018 - Ben Meier |
Rendered by <a href=https://gohugo.io title=Hugo>Hugo</a> |
<a href=https://astromechza.github.io/index.xml>Subscribe</a></h6></footer></div><script src=https://astromechza.github.io/js/scripts.js></script></body></html>
<!doctype html><html lang=en-us><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-49279373-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-49279373-1")</script><title>AstromechZA - Ben Meier</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="The HTML5 Herald"><meta name=author content="Ben Meier"><link href=https://github.com/astromechza rel=me><link href=https://hachyderm.io/@benmeier_ rel=me><meta name=generator content="Hugo 0.110.0"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda"><link rel=stylesheet type=text/css href=https://astromechza.github.io/css/styles.css></head><body><div id=container><header><h1><a href=https://astromechza.github.io/>AstromechZA - Ben Meier</a></h1><ul id=social-media class=fa-ul><li><a href=https://hachyderm.io/@benmeier_><i class="fab fa-mastodon fa-fw"></i></a></li><li><a href=https://twitter.com/@benmeier_><i class="fab fa-twitter fa-fw"></i></a></li><li><a href=https://github.com/AstromechZA><i class="fab fa-github fa-fw"></i></a></li></ul><p><em>My Mind on Code</em></p></header><nav><ul><li><a class=active href=https://astromechza.github.io/posts/><i class="fa-li fa fa-lg"></i><span>All Posts</span></a></li></ul></nav><main><article><h1>Git tag-based auto-versioning scheme</h1><aside><ul><li><time class=post-date datetime=2018-07-12T09:00:00+01:00>Jul 12, 2018</time></li><li><em><a href=https://astromechza.github.io/tags/git/>#git</a>
,
<a href=https://astromechza.github.io/tags/semver/>#semver</a></em></li><li>5 min read</li></ul></aside><p><strong>Versioning is difficult.</strong> I&rsquo;d partly argue that this is the case because there are just so many different methods and strategies!</p><p><strong>NOTE</strong>: if you want to jump straight to the code, click <a href=#code>here</a>.</p><p>There is no right answer that fits all software projects, <a href=https://semver.org/>Semantic Versioning</a> is an attempt at this, but often doesn&rsquo;t fit well for large projects that may have a release cycle as long as 3-6 (even 12) months for a new version (eg: Android, iOS, Windows, etc).</p><p>However SemVer can work <em>very</em> well for small libraries and distributables for which the <code>MAJOR.MINOR.PATCH</code> archetype describes changes in the project very well. It&rsquo;s an obvious choice for languages like Python, who&rsquo;s packaging mechanism requires a version number.</p><p>This post will mostly be concerned with small projects that may be distributed to an audience in which version numbers have some meaning.</p><h3 id=what-information-are-we-trying-to-convey>What information are we trying to convey</h3><p>It&rsquo;s important to take a step back and remember what a version number is telling us (whether it is Semver or a date or a build number).</p><ul><li>What is the <em>latest</em> version?</li><li>What is the version I have, if I already have it installed?</li><li>Is my version any different to the <em>latest</em> version?</li><li>How often does this project release changes?</li><li>Do I gain anything by upgrading?</li><li>What is the magnitude of change that I expect between these versions?</li></ul><p>If your audience (or developers) will not be concerned with these questions then you probably don&rsquo;t need to worry about versioning at all!</p><h3 id=an-evolution-of-my-versioning-practises>An evolution of my versioning practises</h3><p>As I&rsquo;ve gained more experience writing and maintaining software, my personal preference for versioning has changed and evolved (and is likely to keep doing so).</p><p>The first stop was just baking the version into the project files as <code>1.0.0</code> and never adjusting it <em>since I didn&rsquo;t have an audience concerned with the version</em>.</p><p>Then as I learnt about SemVer and saw it used in more places I began using it and attempting to remember to adjust the version file at fairly regular intervals. I only ever bumped the <code>MINOR</code> component (the second digit) and generally did so either too often or with no respect to the real SemVer spec.</p><p>In some projects I used just 2 digits of semver (<code>MAJOR.MINOR</code>) since I was never using the third digit!</p><p>I still kept having silly events where I&rsquo;d intend to fix a bug or add a feature and yet I hadn&rsquo;t bumped the version number which often played havok with CI pipelines overwriting artifacts when not intended. I&rsquo;d then have to go back and add a new commit with the bumped version info.</p><p>To get around that I began providing the version using Git tags. This is a commonly used strategy in many projects these days:</p><ul><li>Don&rsquo;t store the version in the project source code</li><li>Add a Git tag like <code>v1.2.3</code> when you cut a new version</li><li>Use your build/deployment framework to access the latest version tag and use it for the build</li><li>Simply add a new git tag when its time to release a version</li><li>If your Git provider supports it, protect the tag pattern <code>v\d+\.\d+\.\d+</code> so that it can only be used on master and can only be pushed by certain users.</li></ul><p>This made managing the version pretty nice but still presented the problem in my projects that I&rsquo;d never end up updating the <code>PATCH</code>/<code>BUILD</code> number (the 3rd digit).</p><p>This brings us to my current preferred way of doing version managment. <strong>Forewarning: it uses a lot of Git</strong>.</p><h3 id=the-technique>The technique</h3><p>Briefly:</p><ul><li>Use Git tags to store the 2 digit version tag (<code>v1.2</code>)</li><li>The version of any commit, is the most recent, and highest version tag found for any parent commit on the master branch</li><li>The 3rd number (the PATCH or BUILD) is <em>dynamically</em> calculated as the distance in &ldquo;merge&rdquo; commits since the version tag (this can be relaxed to be any type of commits if you&rsquo;re not using merge commits)</li><li>Add a <code>-devX</code> suffix if Git is not clean, or the distance to the last parent commit on the master branch is > 0</li></ul><p><strong>Note:</strong> A &ldquo;merge&rdquo; commit is one which has more than one parent. Usually as a result of a <code>git merge</code> or something.</p><p></p><h3 id=how-its-implemented-in-a-project>How it&rsquo;s implemented in a project</h3><p>In some crazy world you could get away with implementing this in a <code>Makefile</code>. However, this is not that world so I prefer to write it as a broadly compatible Python script that a <code>Makefile</code> can call if necessary.</p><p>You can then use the <code>ver.py</code> file to access the version number when you need it during build and deployment. An example of the version progression may be:</p><pre tabindex=0><code>$ for r in $(git rev-list HEAD); do git --no-pager show $r -s --oneline; python ver.py --ref $r; done
365a400 (HEAD -&gt; feature-D) My most recent commit
0.1.0-dev1
3789ecb (origin/master, master, v0.1) Merge feature-C to master
0.1.0
f00386a (origin/feature-B) Work on feature C
0.0.13-dev1
37b46ef Merge feature-B to master
0.0.13
42a4fcf (origin/feature-B) More work on feature B
0.0.12-dev2
b93c2d1 Work on feature B
0.0.12-dev1
ba544ba Merge feature-A to master
0.0.12
...
</code></pre><p>It&rsquo;s a good idea to only deploy new artifacts when you&rsquo;re sure your building the release branch and that the version number has no <code>-devX</code> suffix indicating unmerged changes.</p><p>In a Python project, you could access and use the version number as follows in your <code>setup.py</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> imp 
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> setuptools <span style=color:#f92672>import</span> setup, find_packages
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># you could run it via subprocess but this avoids the fork</span>
</span></span><span style=display:flex><span>version <span style=color:#f92672>=</span> imp<span style=color:#f92672>.</span>load_source(<span style=color:#e6db74>&#39;version&#39;</span>, os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(__file__, <span style=color:#e6db74>&#39;../ver.py&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>setup(
</span></span><span style=display:flex><span>    <span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>    version<span style=color:#f92672>=</span>version<span style=color:#f92672>.</span>get_version(),
</span></span><span style=display:flex><span>    <span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><h3 id=possible-additions-and-extensions>Possible additions and extensions</h3><ul><li>Always add <code>-devX</code> when you&rsquo;re not on the release branch</li><li>When adding the <code>-devX</code> suffix, bump the <code>PATCH</code> digit in preperation for a new version (so that <code>1.2.3</code> &lt; <code>1.2.4-dev</code> &lt; <code>1.2.4</code>)</li><li>Add a command to bump the minor or major versions (publish a new git tag based on the last one)</li></ul></article><section class=post-nav><ul><li><a href=https://astromechza.github.io/posts/2018-06-29-ipvs/><i class="fa fa-chevron-circle-left"></i> A Minimal IPVS Load Balancer demo</a></li><li><a href=https://astromechza.github.io/posts/2018-08-12-coordinated-omission/>Coordinated Omission in load measurements <i class="fa fa-chevron-circle-right"></i></a></li></ul></section></main><footer><h6>Copyright © 2018 - Ben Meier |
Rendered by <a href=https://gohugo.io title=Hugo>Hugo</a> |
<a href=https://astromechza.github.io/index.xml>Subscribe</a></h6></footer></div><script src=https://astromechza.github.io/js/scripts.js></script></body></html>